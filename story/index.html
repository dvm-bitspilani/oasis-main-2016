<!DOCTYPE html>
<html>
<head>
    <title>TEST</title>
    <script type="text/javascript" src="gl-matrix-2.3.2min.js"></script>
    <link rel="stylesheet" href="loader.css" media="screen" title="no title" charset="utf-8">
    <style type="text/css">



    </style>
</head>
<body>
  <div>
  <canvas id="inkCanvas" width="298" height="168"></canvas>
  <div class="loader" >
    <div class="loadImg" >


      <svg
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:cc="http://creativecommons.org/ns#"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns="http://www.w3.org/2000/svg"
         xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
         xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
         version="1.1"
         id="Layer_1"
         x="0px"
         y="0px"
         width="478.8765"
         height="478.8757"
         viewBox="0 0 478.87649 478.87571"
         enable-background="new 0 0 1000 1000"
         xml:space="preserve"
         inkscape:version="0.91 r"
         sodipodi:docname="loaderSm.svg"><metadata
           id="metadata37"><rdf:RDF><cc:Work
               rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type
                 rdf:resource="http://purl.org/dc/dcmitype/StillImage" /><dc:title></dc:title><dc:title></dc:title></cc:Work></rdf:RDF></metadata><defs
           id="defs35" /><sodipodi:namedview
           pagecolor="#ffffff"
           bordercolor="#666666"
           borderopacity="1"
           objecttolerance="10"
           gridtolerance="10"
           guidetolerance="10"
           inkscape:pageopacity="1"
           inkscape:pageshadow="2"
           inkscape:window-width="1313"
           inkscape:window-height="744"
           id="namedview33"
           showgrid="false"
           inkscape:zoom="0.66980659"
           inkscape:cx="-167.76644"
           inkscape:cy="324.477"
           inkscape:window-x="53"
           inkscape:window-y="24"
           inkscape:window-maximized="1"
           inkscape:current-layer="Layer_1"
           fit-margin-top="0"
           fit-margin-left="0"
           fit-margin-right="0"
           fit-margin-bottom="0" />
           <!-- <ellipse
           style="fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:11.71000004;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
           id="backCircle"
           cx="240.00943"
           cy="237.40295"
           rx="208.55942"
           ry="208.31824" /> -->
           <g
           id="g3"
           style="opacity:0.7"
           transform="matrix(0.79051351,0,0,0.79051351,-180.68056,-139.70113)"><path
             d="m 531.45,176.722 c -167.281,0 -302.889,135.608 -302.889,302.889 0,167.281 135.608,302.889 302.889,302.889 167.281,0 302.89,-135.608 302.89,-302.889 0,-167.281 -135.609,-302.889 -302.89,-302.889 m 0,582.278 C 377.148,759 252.061,633.913 252.061,479.611 c 0,-154.302 125.087,-279.389 279.389,-279.389 154.303,0 279.39,125.087 279.39,279.389 C 810.84,633.913 685.753,759 531.45,759"
             id="path5"
             class="lineMo"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" >
               <!-- <animate attributeName="stroke-dashoffset" dur="6s" to="-820" repeatCount="indefinite"></animate> -->
             </path><path
             d="m 543.333,500.197 -0.458,149.734 -100.526,52.705 c 0,0 53.806,25.802 107.3,20.076 0,0 4.888,-0.471 5.369,-1.842 0.481,-1.371 -3.439,-3.993 -3.439,-3.993 L 536.35,706.622 c 0,0 6.195,-14.936 22.387,-9.542 l 55.413,32.685 c 0,0 2.978,2.166 0.18,3.602 -2.798,1.436 -120.364,35.41 -205.272,-20.701 l 0,-101.17 63.604,-38.457 c 1.038,3.712 2.952,13.528 3.651,18.148 0.486,3.211 0.384,1.5 0.562,4.326 -15.575,7.919 -30.74,20.587 -46.314,28.506 l 0.021,58.637 88.613,-54.032 0,-128.625 c 2.736,-0.925 21.471,-0.753 24.138,0.198"
             id="path7"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="m 551.767,483.045 132.846,67.846 -0.254,115.563 c 0,0 49.219,-37.583 68.449,-87.828 0,0 1.804,-4.567 0.802,-5.62 -1.002,-1.052 -5.121,1.246 -5.121,1.246 l -16.06,8.9 c 0,0 -10.481,-12.312 1.685,-24.277 l 54.313,-34.483 c 0,0 3.283,-1.667 3.289,1.478 0.006,3.146 -23.209,123.299 -111.8,173.396 l -90.1,-46.015 0.128,-72.434 c 3.779,0.764 7.942,1.822 12.375,3.3 3.081,1.028 5.926,2.137 8.523,3.264 -0.031,17.473 -0.063,34.944 -0.093,52.416 l 47.776,24.376 0.199,-99.398 -118.113,-60.321 c 0.42,-2.857 9.096,-19.466 11.156,-21.409"
             id="path9"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="m 545.26,455.757 125.722,-75.646 100.2,62.262 c 0,0 -5.281,-61.701 -37.345,-104.902 0,0 -2.885,-3.974 -4.311,-3.694 -1.426,0.28 -1.698,4.99 -1.698,4.99 l -1.114,18.326 c 0,0 -16.015,2.234 -19.576,-14.456 l 0.069,-64.334 c 0,0 0.355,-3.664 3.012,-1.981 2.656,1.683 91.559,85.781 86.257,187.416 l -87.195,51.306 -61.03,-30.98 c 1.869,-2.806 4.36,-6.072 7.625,-9.407 3.159,-3.228 6.267,-5.727 8.959,-7.626 14.723,9.408 29.612,13.722 44.336,23.129 l 46.217,-27.219 -85.637,-51.699 -112.42,65.421 c -2.185,-1.89 -11.538,-18.125 -12.071,-20.906"
             id="path11"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="m 516.5,458.499 0.14,-148.914 101.341,-55.546 c 0,0 -56.67,-24.971 -109.957,-17.567 0,0 -4.87,0.624 -5.31,2.009 -0.438,1.385 3.563,3.884 3.563,3.884 l 15.545,9.771 c 0,0 -5.725,15.122 -22.076,10.24 l -56.412,-30.929 c 0,0 -3.045,-2.07 -0.293,-3.593 2.751,-1.523 122.37,-38.605 208.998,14.812 l 0,100.552 -56.931,33.291 c -1.508,-1.812 -3.242,-4.262 -4.733,-7.384 -2.358,-4.937 -3.107,-9.465 -3.354,-12.512 l 43.132,-25.237 -0.144,-54.452 -86.677,50.999 0,130.914 c -2.704,1.01 -24.136,0.529 -26.832,-0.338"
             id="path13"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="M 506.333,481.213 376.805,409.47 376.645,293.5 c 0,0 -49.016,40.746 -68.358,90.949 0,0 -1.814,4.563 -0.815,5.618 1,1.054 5.124,-1.235 5.124,-1.235 l 16.079,-8.864 c 0,0 10.455,12.334 -1.738,24.273 l -54.389,34.363 c 0,0 -3.286,1.659 -3.285,-1.485 0.001,-3.145 25.52,-125.752 114.222,-175.651 l 87.96,48.72 -0.279,66.229 c -2.316,0.44 -3.482,0.475 -6.936,0.266 -5.46,-0.329 -11.28,-1.921 -14.064,-3.183 l 0.316,-49.905 -45.396,-24.782 0.309,99.058 114.52,63.431 c -0.426,2.856 -11.517,17.973 -13.582,19.911"
             id="path15"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="M 517.617,493.807 392.166,569.868 291.201,514.435 c 0,0 9.983,62.953 43.255,105.229 0,0 2.996,3.892 4.413,3.571 1.418,-0.321 1.557,-5.036 1.557,-5.036 l 0.596,-18.351 c 0,0 15.944,-2.686 19.977,13.896 l 1.75,64.312 c 0,0 -0.253,3.673 -2.955,2.064 -2.703,-1.606 -95.06,-86.188 -92.633,-187.933 l 86.822,-50.72 58.801,32.218 c -0.805,2.216 -3.383,5.096 -5.327,7.958 -3.073,4.526 -5.657,7.34 -8.164,9.088 l -44.496,-24.393 -44.497,26.363 88.971,49.161 109.146,-66.563 c 2.236,1.826 8.59,15.743 9.2,18.508"
             id="path17"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /><path
             d="m 531.451,447.721 c -17.383,0 -31.474,14.091 -31.474,31.473 0,17.382 14.091,31.473 31.474,31.473 17.382,0 31.473,-14.091 31.473,-31.473 0,-17.382 -14.091,-31.473 -31.473,-31.473 z m -10e-4,45.281 c -7.627,0 -13.809,-6.182 -13.809,-13.809 0,-7.627 6.182,-13.809 13.809,-13.809 7.627,0 13.81,6.182 13.81,13.809 0,7.627 -6.183,13.809 -13.81,13.809 z"
             id="path19"
             inkscape:connector-curvature="0"
             style="fill:#ffffff" /></g><path
           d="m 109.88929,188.84657 0.33913,-74.74938 c 0,0 -24.411062,15.38735 -26.883002,30.12963 l 9.62372,0.12965 -0.15494,21.47667 -0.0972,13.55177 -61.55017,36.63003 c -0.44427,5.50829 -0.87747,12.77074 -0.93597,20.56995 l 63.59681,-38.41263 73.054522,40.16994 -34.30354,21.12964 -31.92568,-18.2166 c 0,0 -11.905142,2.26957 -15.902762,8.38577 l 48.114602,27.33596 65.19602,-39.67667 -88.1715,-48.45373 z"
           id="path21"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" /><path
           d="M 384.88839,300.25759 446.94923,266.875 c 1.05613,-6.93281 1.60632,-14.17075 1.87826,-20.56126 l -64.18495,34.68062 -78.02843,-39.80236 40.48852,-24.19841 36.53516,18.7992 c 0,0 12.31225,-2.65059 16.59842,-8.56837 l -52.70907,-27.08616 -71.96598,42.6324 92.39917,47.25848 0.005,73.03791 c 0,0 21.38339,-13.08142 24.55889,-27.68694 l -8.5336,-1.37075 0.89803,-33.75177 z"
           id="path23"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" /><path
           d="m 400.36822,153.23552 -5.29644,6.83003 -29.16995,-18.64347 0.49565,-71.474284 c -5.10355,-3.05929 -11.08932,-6.57944 -17.15256,-9.99841 l -0.3747,74.107484 -72.51302,42.50196 0,-41.3905 32.47588,-19.01976 c 0,0 3.98419,-10.06956 0.84901,-16.669554 l -48.16915,28.310664 0,73.0719 87.25293,-51.3399 64.13041,40.99999 c 0,-7.9e-4 -1.23557,-27.4909 -12.52806,-37.28615 z"
           id="path25"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" /><path
           d="m 281.38724,65.699576 c 0,0 -24.64663,-12.23873 -38.68615,-7.1075 l 3.40791,7.94307 -29.35019,17.56996 -62.10749,-35.34702 c -5.39288,2.74782 -11.73833,6.08221 -17.92963,9.57944 l 64.25056,36.01263 -0.13043,82.821314 -34.03161,-18.84979 0.0727,-36.75809 c 0,0 -7.85375,-9.23083 -15.14703,-9.68616 l -0.005,55.33753 65.35333,35.92172 -0.0711,-99.42526 64.37389,-38.011844 z"
           id="path27"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" /><path
           d="m 129.39284,321.06865 -64.223692,-34.7826 c 0,0 1.31699,25.0332 12.64821,34.7826 l 5.26957,-6.85059 29.249002,16.86402 -0.20633,74.6308 c 4.36759,3.67273 10.18577,8.06166 16.85296,11.83162 l 0.41028,-77.50353 73.5889,-45.02844 0,45.44583 -33.36599,20.22766 c 0,0 -3.16206,16.70751 0,23.29486 l 49.96677,-30.21422 0,-87.547 -90.18968,54.84899 z"
           id="path29"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" /><path
           d="m 321.59829,431.21011 c 5.58735,-2.33518 12.41106,-5.47668 20.22766,-9.61897 l -69.3889,-35.30434 0.33834,-85.61182 36.50828,18.67905 -0.0166,37.47192 c 0,0 9.15178,8.65217 16.45612,8.83715 l 0.14388,-56.47192 -70.16124,-35.89722 0.19921,107.20945 -60.498,30.70275 c 0,0 22.93754,14.94308 36.77785,9.29723 l -3.69881,-7.81264 28.54149,-14.49723 64.57072,33.01659 z"
           id="path31"
           inkscape:connector-curvature="0"
           style="opacity:0.7;fill:#ffffff" />
           <ellipse
           id="animateRing"
           cx="240.16479"
           cy="239.39764"
           rx="215.0961"
           ry="217.54649" >
              <animate attributeName="stroke-dashoffset" dur="3s" to="0" begin="0s" repeatCount="1" fill="freeze" onend="loaded()"/>
           </ellipse></svg>
    </div>
  </div>
</div>
  <div  class="scroll">
    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    width="100%" height="100%" viewBox="0 0 50 400" enable-background="new 0 0 50 400" xml:space="preserve">
    <g opacity="0.8">
      <ellipse id="currentRing" opacity="0.7" fill="none" stroke="#FBB040" stroke-width="2.4533" stroke-miterlimit="10" cx="25" cy="14.772" rx="10.459" ry="9.413"/>
      <ellipse class="slide"  slide="1" fill="#FFFFFF" cx="25" cy="14.772" rx="5.46" ry="4.915"/>
      <ellipse class="slide"  slide="2" fill="#FFFFFF" cx="25" cy="87.146" rx="5.46" ry="4.915"/>
      <ellipse class="slide" slide="3" fill="#FFFFFF" cx="25" cy="160.746" rx="5.46" ry="4.915"/>

      <ellipse class="slide" slide="4" fill="#FFFFFF" cx="25" cy="234.347" rx="5.46" ry="4.914"/>
      <ellipse class="slide" slide="5" fill="#FFFFFF" cx="25" cy="310.4" rx="5.46" ry="4.914"/>
      <line fill="none" stroke="#FFFFFF" stroke-width="0.9301" stroke-miterlimit="10" x1="25" y1="14.772" x2="25" y2="87.944"/>
      <line fill="none" stroke="#FFFFFF" stroke-width="0.9301" stroke-miterlimit="10" x1="25" y1="87.146" x2="25" y2="160.317"/>
      <line fill="none" stroke="#FFFFFF" stroke-width="0.9301" stroke-miterlimit="10" x1="25" y1="160.746" x2="25" y2="233.918"/>
      <line fill="none" stroke="#FFFFFF" stroke-width="0.9301" stroke-miterlimit="10" x1="25" y1="234.347" x2="25" y2="307.519"/>
    </g>
  </svg>

</div>
  <div class="cd-transition-layer" style="display:none">
    	<div class="bg-layer inkAnim"></div>
    </div>

  <div class="item" display="none">
  <ul>
    <li  value="moseshi.jpg" class="storyType" onclick="selectStory(this)" active="true">Moses</li>
    <li value="mahabharatcopy.jpg" class="storyType" onclick="selectStory(this)" active="false">Mahabharat</li>
    <li value="troyfinal.jpg"class="storyType" onclick="selectStory(this)" active="false">Troy</li>
    <li value="noah(1).jpg" class="storyType" onclick="selectStory(this)" active="false">Noah</li>
  </ul>
</div>
<div id="storyWrap">
  <div id="fakeScroll"></div>
  <div class="wrap plainImg">
  <canvas id="canvas"></canvas>
  </div>
  <!-- <div class="blurImg">
    <img src="moseshi.jpg" alt="" />
  </div> -->
</div>

<div class="storyContentWrap">
  <div class="storyWrap">
    <p class="storyText">
    Lorem ipsum dolor sit amet, mundi ocurreret ei eum. Et principes omittantur vim
    </p>
  </div>
</div>
</body>
<script type="text/javascript" src="index.js"></script>
<script src="../js/jquery.min.js"> </script>
<script src="../js/jquery.ba-throttle-debounce.js"> </script>
<script type="text/javascript">

$(window).load(function() {
  loadingdone();

});


var css3AnimationSupport = (function(){
    var div = document.createElement('div'),
        divStyle = div.style,
        // you'll probably be better off using a `switch` instead of theses ternary ops
        support = {
            transition:
                divStyle.MozTransition     === ''? {name: 'MozTransition'   , end: 'transitionend'} :
                // Will ms add a prefix to the transitionend event?
                (divStyle.MsTransition     === ''? {name: 'MsTransition'    , end: 'msTransitionend'} :
                (divStyle.WebkitTransition === ''? {name: 'WebkitTransition', end: 'webkitTransitionEnd'} :
                (divStyle.OTransition      === ''? {name: 'OTransition'     , end: 'oTransitionEnd'} :
                (divStyle.transition       === ''? {name: 'transition'      , end: 'transitionend'} :
                false)))),
            transform:
                divStyle.MozTransform     === '' ? 'MozTransform'    :
                (divStyle.MsTransform     === '' ? 'MsTransform'     :
                (divStyle.WebkitTransform === '' ? 'WebkitTransform' :
                (divStyle.OTransform      === '' ? 'OTransform'      :
                (divStyle.transform       === '' ? 'transform'       :
                false))))
        };
    support.transformProp = support.transform.replace(/([A-Z])/g, '-$1').toLowerCase();
    return support;
}());

var element = document.querySelector('.cd-transition-layer .bg-layer');

element.addEventListener("webkitAnimationEnd", function(){
    this.style.webkitAnimationName = '';
    console.log(  element.style.webkitAnimation);
    $(element).hide();
    $(element).removeClass('inkAnim');
}, false);
element.addEventListener("animationEnd", function(){
    this.style.animationName = '';
    console.log(  element.style.animation);
    $(element).hide();
    $(element).removeClass('inkAnim');
}, false);

function startInkAnim(){
  $(element).show();

  $(element).addClass('inkAnim');

    // element.style.webkitAnimationName = 'cd-sprite';
    // element.style.animationName = 'cd-sprite';
    // element.style.webkitAnimationDirection = "reverse";
    // element.style.animationDirection = "reverse";
    // console.log(  element);

    // you'll probably want to preventDefault here.
};



document.onreadystatechange = function(e)
{
  if(document.readyState=="interactive")
  {
    var all = document.getElementsByTagName("*");
    for (var i=0, max=all.length; i < max; i++)
    {
      set_ele(all[i]);
    }
  }
}
var prog=0;
var d1,d2;
function check_element(ele)
{
  var all = document.getElementsByTagName("*");
  var totalele=all.length;
  var per_inc=100/all.length;

  d1=new Date().getTime();
  if($(ele).on())
  {
    var prog_width=per_inc+prog;
    prog=prog_width;
    // console.log(prog);
    var st=Math.round(13.60*(100-prog));
    var loader =  document.querySelector('.loader #animateRing');
    d2=new Date().getTime();
    // console.log(d2-d1);
    d1=d2;
    // loader.style.strokeDashoffset=st;
    // console.log(loader.style);
    // $('.loader #animateRing').css(
    //   {'stroke-dashoffset': st});
    // document.getElementById("progress_width").value=prog_width;
    // $("#bar1").animate({width:prog_width+"%"},10,function(){
    //   if(document.getElementById("bar1").style.width=="100%")
    //   {
    //     $(".progress").fadeOut("slow");
    //   }
    // });
  }

  else
  {
    set_ele(ele);
  }
}


function set_ele(set_element)
{
  check_element(set_element);
}

function selectStory(ele){
  var eleArr=document.getElementsByClassName('storyType');
  for(var i =0;i<eleArr.length;i++){
   var element=eleArr[i];
    if(element.getAttribute('active')=='true'){
      element.setAttribute('active','false');
    }
  };
  ele.setAttribute('active','true');
  // webGLStart();
}
// $(window).on('scroll', function () {
//     var pixs = $(document).scrollTop()/10;
//     pixs = pixs / 100;
//     $("#storyWrap").css({"-webkit-filter": "blur("+pixs+"px)","filter": "blur("+pixs+"px)" })
// });
//


var ScrollSpeedMonitor = (function()
{
    var self = this;

    function ScrollSpeedMonitor (callbackMethod)
    {
        callback = callbackMethod;

        $(window).scroll(function(e)
        {
            var scrollTop = $(this).scrollTop();
            didScroll(new Date().getTime(), scrollTop);
        });
    }

    var callback;
    var direction = 'unknown';
    var lastDate = -1;
    var lastScrollTop = -1;

	this.thisMinimumTrackingDelayInMs = 25;

    function didScroll (timeStamp, scrollTop)
    {
		if (lastDate + self.thisMinimumTrackingDelayInMs <= timeStamp)
		{
			var offset = Math.abs(scrollTop - lastScrollTop);
			var direction = getDirection(scrollTop);
			var delayInMs = timeStamp - lastDate;
			var speedInPxPerMs = offset / delayInMs;

			if (speedInPxPerMs > 0)
			{

				callback(speedInPxPerMs, timeStamp, direction);
			}

			lastDate = timeStamp;
		}
    };

    function getDirection (scrollTop)
    {
        var currentScrollTop = lastScrollTop;
        lastScrollTop = scrollTop;

        if (currentScrollTop > -1)
        {
            if (currentScrollTop >= scrollTop)
            {
                return 'down';
            }

            return 'up';
        }

        return 'unknown';
    }

	function reset ()
	{
		direction = 'unknown';
		lastDate = -1;
		lastScrollTop = -1;
	}

    return ScrollSpeedMonitor;
}());


var scrollSpeedMonitor = new ScrollSpeedMonitor(function (speedInPxPerMs, timeStamp, newDirection)
{
    manageBlur(speedInPxPerMs);
});


var time1,time2;
function manageBlur(scroll){


      pixs = scroll* 10;
      // if(pixs>60)
      //   pixs=60;
      $("#storyWrap").css({"-webkit-filter": "blur("+pixs+"px)","filter": "blur("+pixs+"px)" });
      if(pixs<12){
        $("#storyWrap").css({"-webkit-filter": "blur(0px)","filter": "blur(0px)" })
      }
      // $("#storyWrap").animate({"webkit-filter": "blur("+pixs+"px)","filter": "blur("+pixs+"px)" })
}

console.log(location.search,'k');
// location.reload(false);
// window.addEventListener=("scroll",function(){
//          clearTimeout( $.data( this, "scrollCheck" ) );
//          $.data( this, "scrollCheck", setTimeout(function() {
//            console.log('stop');
//            $("#storyWrap").css({"-webkit-filter": "blur(0px)","filter": "blur(0px)" })
//
//          }, 250) );
//
//        });

    //    $(document).on("scrollstop",function(){
    //      console.log('hi');
    //      $("#storyWrap").css({"-webkit-filter": "blur(0px)","filter": "blur(0px)" })
    // });
// $(window).scroll($.debounce( 250, true, function(){
//   $('.blurImg').fadeIn();
//
// } ) );
// $(window).scroll($.debounce( 250, function(){
// $('.blurImg').fadeOut();
//
// } ) );

// window.addEventListener('scroll',function(e){
//
// });


var canvas = document.querySelector("#inkCanvas");
var context = canvas.getContext("2d");
var sNo=window.location.hash.charAt(1);
var bg = new Image();
bg.src = "../img/inkbg"+sNo+".jpg";
var myImage = new Image();
myImage.src = "../img/mask.png";

// myImage.addEventListener("load", loadImage, false);

// function loadImage(e) {
//   animate();
// }

var shift = 0;
var frameWidth = 298;
var frameHeight = 168;
var totalFrames = 40;
var currentFrame = 0;
var maxSpeed=3;
var speedvar=0;

function animate() {
  context.clearRect(0, 0, 298, 168);
  context.globalCompositeOperation = "xor";

//draw each frame + place them in the middle
context.drawImage(myImage, shift, 0, frameWidth, frameHeight, 0, 0, frameWidth, frameHeight);
// context.globalCompositeOperation = "multiply";
context.drawImage(bg, 0, 0, 1600,907,0,0,frameWidth,frameHeight);
if (speedvar==maxSpeed){
  shift += frameWidth;
  speedvar=0;
}
/*
  Start at the beginning once you've reached the
  end of your sprite!
  */
  if (currentFrame != totalFrames*maxSpeed) {
    // shift = 0;
    // currentFrame = 0;
    requestAnimationFrame(animate);
    currentFrame++;
  }

  speedvar++;
  if (currentFrame == totalFrames*maxSpeed) {
    $('#inkCanvas').fadeOut();
  }
}

function loadingdone () {
  webGLStart();
  setTimeout(function () {
    $('.loader').fadeOut('slow');
    $('.container').css('display', 'block');
    animate();

},3000);
}


$('.loader').css({
  background:'url("../img/inkbg'+sNo+'.jpg")'
})


</script>
<script id="vertex-shader" type="x-shader/x-vertex">
    attribute vec2 aTextureCoord;
    attribute vec2 aVertexPosition;

    uniform bool uIsBuffer;
    uniform float uBGAspect;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform float u_kernel[9];

    varying vec2 vTextureCoord;

    void main() {
        vec4 XY;

        if (uIsBuffer) {
            // Appy corrct aspect
            XY = vec4(aVertexPosition * vec2(1, uBGAspect), 0.7, 1);
        } else {
            // Appy Model-View-Model matrix transformation
            XY = uPMatrix * uMVMatrix * vec4(aVertexPosition, 0, 1);
        }

        gl_Position = XY;
        vTextureCoord = aTextureCoord;
    }
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
    precision mediump float;

    uniform bool uIsBuffer;
    uniform sampler2D uSampler;
    uniform vec2 uInitialTextureOffset;
    uniform vec2 uTextureOffset;
    uniform vec2 uTextureSize;
    varying vec2 vTextureCoord;
     vec2 onePixel;
    vec2 arctanDistortion(vec2 XY, float factor, vec2 multiplier);
    vec2 arctan2Distortion(vec2 XY, vec2 factor, vec2 multiplier);
    vec2 linearDistortion(vec2 XY, vec2 multiplier);
    vec2 parabolicDistortion(vec2 XY, vec2 multiplier);
    vec2 polynomialDistortion(vec2 XY, float factor, vec2 multiplier);
    vec2 polynomial2Distortion(vec2 XY, vec2 factor, vec2 multiplier);

    void main() {
        vec2 XY;

        if (uIsBuffer) {
            // Add initial and current offset
            XY = vTextureCoord + uInitialTextureOffset + uTextureOffset;
        } else {
            vec2 multiplier = vec2(0.11, 0);
            vec2 recover = vec2(1.05, 1);
            float factor = .7; // can also be vec2
            vec2 originOffset = vec2(0, 0.3);

            XY = vTextureCoord;
            float R;
            bvec2 isValid;

            /*Normalize components from range {0, 1} to {-1, 1}*/
            XY = (2. * XY) - 1.;

            /*Shift offset*/
            XY += originOffset;

            /*Calculate distortion*/
            // XY = arctanDistortion(XY, factor, multiplier);
            // XY = arctan2Distortion(XY, factor, multiplier);  // typeof factor === vec2
            // XY = linearDistortion(XY, multiplier);
            XY = parabolicDistortion(XY, multiplier);
            // XY = polynomialDistortion(XY, factor, multiplier);
            // XY = polynomial2Distortion(XY, factor, multiplier);  // typeof factor === vec2

            /*Reset origin*/
            XY -= originOffset;

            /*Recover edges*/
            XY *= recover;

            /*Filter valid regions*/
            isValid = lessThanEqual(abs(XY), vec2(1, 1));
            if (isValid.x && isValid.y) {
                /*De-normalize*/
                XY = (XY + 1.) / 2.;
            } else {
                discard;
            }
        }

        onePixel = vec2(1.0, 1.0) / uTextureSize;

        // gl_FragColor = (
        //    texture2D(uSampler, XY) +
        //    texture2D(uSampler, XY + vec2(onePixel.x, 0.0)) +
        //    texture2D(uSampler, XY + vec2(-onePixel.x, 0.0))) / 3.0;
        gl_FragColor = texture2D(uSampler, XY);
    }

    vec2 arctanDistortion(vec2 XY, float factor, vec2 multiplier) {
        if (factor == 0.) {
            return XY * (1. + multiplier);
        }

        float t = factor * length(XY);
        float R = atan(t) / t;
        return XY * (1. + multiplier) * R;
    }

    vec2 arctan2Distortion(vec2 XY, vec2 factor, vec2 multiplier) {
        vec2 t = factor * length(XY);
        vec2 R;

        if (factor.x == 0. || factor.y == 0.) {
            if (factor.x == 0.) {
                R = vec2(1, atan(t.y) / t.y);
            }
            if (factor.y == 0.) {
                R = vec2(atan(t.x) / t.x, 1);
            }
        } else {
            R = atan(t) / t;
        }

        return XY * (1. + multiplier) * R;
    }

    vec2 linearDistortion(vec2 XY, vec2 multiplier) {
        float R = length(XY);
        return XY * (1. - multiplier * R);
    }

    vec2 parabolicDistortion(vec2 XY, vec2 multiplier) {
        float R = dot(XY, XY);
        return XY * (1. - multiplier * R);
    }

    vec2 polynomialDistortion(vec2 XY, float factor, vec2 multiplier) {
        float R = pow(length(XY), factor);
        return XY * (1. - multiplier * R);
    }

    vec2 polynomial2Distortion(vec2 XY, vec2 factor, vec2 multiplier) {
        vec2 R = pow(vec2(length(XY), length(XY)), factor);
        return XY * (1. - multiplier * R);
    }
</script>
</html>
