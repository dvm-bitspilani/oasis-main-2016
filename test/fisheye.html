<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		body {
			margin: 0;
			padding: 0;
			overflow-y:scroll;
			overflow-x: hidden;
			width: 1280px;
			height: 8296px;
		}

		#blurImg {
			display: flex;
			flex-direction: row;
			justify-content: center;
			position: absolute;
			z-index: 999;
			display: none;
			top:0;
			left:-12.5vw;
			width: 125vw;
			height: auto;
		}
	</style>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="jquery.ba-throttle-debounce.js"> </script>


</head>
<body>
	<canvas style="position: fixed; width: 125vw; left: -12vw;display: block; height: auto; top: -13vh;" id="canvas" width="1280" height="622"></canvas>
	<canvas id="canvasCrop" width="1280" height="622" style="display:block;position:fixed;width:100vw;height:100vh;"></canvas>

	<img id="canvasImg" src="moses.jpg">
	<div id="blurImg">
    <img src="moses.jpg" width="100%" alt="" />
  </div>

	<script src="fisheye.js"></script>
	<script type="text/javascript">

		$(window).scroll(function() {
			if (checkScrollSpeed()==0)
				fishfuck();
		});

		fishfuck();
		

		function fishfuck () {

			var canvasCrop = document.getElementById('canvasCrop');
			var context = canvasCrop.getContext('2d');
			var canvasImg = document.getElementById('canvasImg');
			var imageObj = new Image();
			imageObj.src = 'moses.jpg';

        // draw cropped image
        var sourceX = 0;
        var sourceY = $(window).scrollTop();
        var sourceWidth = 1280;
        var sourceHeight = 622;
        var destWidth = sourceWidth;
        var destHeight = sourceHeight;
        var destX = canvasCrop.width / 2 - destWidth / 2;
        var destY = canvasCrop.height / 2 - destHeight / 2;
        context.drawImage(canvasImg, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, destWidth, destHeight);

        var dataURL = canvasCrop.toDataURL();

        if (dataURL!=undefined) {
        	// console.log(dataURL);
        }

      // set canvasImg image src to dataURL
      // so it can be saved as an image
      

      // var canvas = document.getElementById('canvas');
      // canvas.width = 1280;
      // canvas.height = 622;
      // var fisheye = new Fisheye(canvas);

      var img = new Image();
      img.src = dataURL;
      img.crossOrigin = "anonymous";

      if (img.src!=undefined) {
    		// console.log(img.src);
    	}

		// fisheye.setViewport(canvas.width, canvas.height);
		// fisheye.setDistortion(2,2,2);
		// fisheye.clear();

		// function draw() {
			// requestAnimationFrame(draw);
    // Drawing code goes here
		// }
		// draw();
		// setTimeout(function() {
		// 	// canvasCrop.onload = function () {
		// 	fisheye.clear();
		// 	fisheye.draw(img);
		// 	// console.log('ok');
		// },800);
	};

	var checkScrollSpeed = (function(settings){
		settings = settings || {};

		var lastPos, newPos, timer, delta, 
        delay = settings.delay || 50; // in "ms" (higher means lower fidelity )

        function clear() {
        	lastPos = null;
        	delta = 0;
        }

        clear();

        return function(){
        	newPos = window.scrollY;
      if ( lastPos != null ){ // && newPos < maxScroll 
      	delta = newPos -  lastPos;
      }
      lastPos = newPos;
      clearTimeout(timer);
      timer = setTimeout(clear, delay);
      return delta;
  };
})();

// listen to "scroll" event
// window.onscroll = function(){
// 	console.log( checkScrollSpeed() );
// };


// $(window).scroll($.debounce( 250, true, function(){
//     $('#blurImg').fadeIn();

// } ) );
// $(window).scroll($.debounce( 250, function(){
//   $('#blurImg').fadeOut();

// } ) );
</script>
</body>
</html>